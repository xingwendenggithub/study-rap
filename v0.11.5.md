<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [RAP v0.11.5](#rap-v0115)
  - [# RAP v0.11.5](#-rap-v0115)
  - [背景](#%E8%83%8C%E6%99%AF)
  - [需求设计](#%E9%9C%80%E6%B1%82%E8%AE%BE%E8%AE%A1)
    - [团队管理](#%E5%9B%A2%E9%98%9F%E7%AE%A1%E7%90%86)
    - [平台成员管理](#%E5%B9%B3%E5%8F%B0%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86)
    - [可见性](#%E5%8F%AF%E8%A7%81%E6%80%A7)
    - [访问权限](#%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90)
  - [技术设计](#%E6%8A%80%E6%9C%AF%E8%AE%BE%E8%AE%A1)
    - [团队管理](#%E5%9B%A2%E9%98%9F%E7%AE%A1%E7%90%86-1)
    - [可见性](#%E5%8F%AF%E8%A7%81%E6%80%A7-1)
    - [访问权限](#%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90-1)
  - [其它问题](#%E5%85%B6%E5%AE%83%E9%97%AE%E9%A2%98)
    - [数据迁移](#%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# RAP v0.11.5
----------------
| 版本 | 更新时间 | 备注 |
| ---- | ------- | :--- |
| v0.1.0 | 2015/10/09 | 初稿 |
| v0.1.1 | 2015/10/10 | 完善团队管理部分, 新增项目私有 |

## 背景
现外网部署的RAP Server越来越多，安全及权限控制非常重要。因此前我们主要考虑内网部署RAP服务器的情况，在权限管理上做的非常弱，本次升级将增强权限管理、提升安全性。增加团队管理，权限控制等功能。使RAP具备部署到公网使用的条件。同时，也会修复BUGs，完善用户体验。

## 需求列表
1. 增加**团队管理**，可设置团队成员及权限
2. 可见性调整：**不再使所有项目公开**，必须加入到团队后，才能看到该团队下的业务线、分组及项目。
3. 改写文档必须是项目成员或创建者，其他团队成员可以查看该团队下的所有项目，但不可修改。
4. 项目可被设置为私密项目，设置为私密项目时，仅允许项目成员查看/修改。其他同团队成员仍然不能查看。
5. Bugs修复(见issues)

### 团队管理

```
注：以下实例图瞎画的，实际实现效果看我当时心情... d-  o-b|||
```

未创建团队，且未被加入到任何团队的用户（团队为空），在团队菜单位置显示“创建团队”。

<img src="http://gtms02.alicdn.com/tps/i2/TB1rnTaJVXXXXXCXXXXSW0ZKpXX-1250-934.png" width="400" />

有所在团队时，显示团队列表及创建团队按钮

<img src="http://gtms01.alicdn.com/tps/i1/TB1cge6JVXXXXXIXpXXDKbWLpXX-1252-302.png" width="400" />

点击创建团队后，出现创建团队会话

<img src="http://gtms02.alicdn.com/tps/i2/TB1wca9JVXXXXcbXXXXjOPj1XXX-1634-852.png" width="600" />

默认为`仅团队成员访问`，如果选择`公开访问`，所有RAP用户都具有该团队项目的只读权限。

若当前登陆用户是该团队的创建者，或管理员，团队名称右边会出现一个设置按钮，点击后进入到团队成员管理。

<img src="http://gtms04.alicdn.com/tps/i4/TB1_SzXJVXXXXbWXpXXX_BoFVXX-4032-2373.jpg" width="600" />

在这个页面可以管理团队中的成员，包括添加/删除成员，增加/移除管理员权限等等。注意，删除成员的同时，也会删除掉该成员参与项目的关系（即被删除用户在该团队下所有项目的项目成员列表中也会被移除）。若项目创建人为该用户，则项目创建人将随机转交给该项目中的其它成员，若项目成员唯一，则会删除该项目。

### 平台成员管理
和团队管理类似，所以也增加RAP平台管理的界面，平台管理员菜单新增项目“用户管理”，显示所有RAP用户，并管理他们的角色。

### 可见性

1. 仅团队成员/团队创建者可以访问团队下的业务线、分组、项目。
2. 在编辑项目成员时，只会出现该团队内的成员。

### 访问权限

1. 团队成员/创建者可以访问该团队的所有业务线、分组、项目。具有该团队所有文档的只读权限。（后续增加私密项目，看大家需求。）
2. 项目成员/创建者才有文档的改写权限。
3. 页面控制台(pageTester）的访问权限与RAP项目权限相同。
4. 只有平台管理员，才具有数据页的访问权限。
## 技术设计

### 团队管理

#### 数据库设计

##### 团队成员关系表

增加团队成员关系表`tb_corporation_and_user`，用于管理团队及成员间关系。role_id关联tb_role, user为一般团队成员，admin为团队管理员, god为超级管理员.

```sql
CREATE TABLE tb_corporation_and_user
(
	user_id int(10) NOT NULL,
	corporation_id int(10) NOT NULL,
	role_id int(10) NOT NULL,

	PRIMARY KEY(user_id, corporation_id),
	FOREIGN KEY(user_id) REFERENCES tb_user(id),
	FOREIGN KEY(corporation_id) REFERENCES tb_corporation(id),
	FOREIGN KEY(role_id) REFERENCES tb_role(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```
##### 团队表增加新列：访问权限

```sql
ALTER TABLE tb_corporation
	ADD COLUMN access_type TINYINT NOT NULL COMMENTS '权限控制, 10普通, 20公开'
		DEFAULT 10;
```

##### 项目增加新列：访问权限

```sql
ALTER TABLE tb_project
	ADD COLUMN access_type TINYINT NOT NULL COMMENTS '权限控制, 10普通, 0私有'
		DEFAULT 10;
```

### 可见性
团队列表仅显示创建/加入的团队

### 访问权限
业务线/分组/项目/页面控制台等页面，访问时做权限验证，验证不通过则跳转至异常页面。

## 其它问题

### 数据迁移

因为阿里内部用户较多，且均为全公开的情况。我们在添加团队时，会存在`公开团队`的选项，若为`公开团队`，则所有用户可见。在做数据迁移时，老的团队均为公开团队。但团队的创建者可以改为`标准团队`。

`标准团队`仅对团队创建者及成员可见，而`公开团队`对全部用户可见。
